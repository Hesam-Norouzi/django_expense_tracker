<h2>Manage Categories</h2>

<form id="add-category-form">
  {% csrf_token %}
  <input type="text" name="name" placeholder="New Category" required>
  <button type="submit">Add</button>
</form>

<ul id="category-list">
  {% for category in categories %}
    <li data-id="{{ category.id }}">
      <span class="cat-name">{{ category.name }}</span>
      <input class="edit-input" type="text" value="{{ category.name }}" style="display:none;">
      <button class="edit-btn">Edit</button>
      <button class="save-btn" style="display:none;">Save</button>
      <button class="delete-btn">Delete</button>
    </li>
  {% endfor %}
</ul>

<script>
document.getElementById('add-category-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = e.target;
    const csrf = form.querySelector('[name=csrfmiddlewaretoken]').value;
    const name = form.querySelector('[name=name]').value;

    fetch("{% url 'add_category_ajax' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrf,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({name})
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            const li = document.createElement('li');
            li.dataset.id = data.id;
            li.innerHTML = `
                <span class="cat-name">${data.name}</span>
                <input class="edit-input" type="text" value="${data.name}" style="display:none;">
                <button class="edit-btn">Edit</button>
                <button class="save-btn" style="display:none;">Save</button>
                <button class="delete-btn">Delete</button>
            `;
            document.getElementById('category-list').appendChild(li);
            form.reset();
        }
    });
});

// delegate edit, save, delete
document.getElementById('category-list').addEventListener('click', function(e) {
    const li = e.target.closest('li');
    const id = li.dataset.id;
    const nameSpan = li.querySelector('.cat-name');
    const input = li.querySelector('.edit-input');

    if (e.target.classList.contains('edit-btn')) {
        nameSpan.style.display = 'none';
        input.style.display = 'inline';
        li.querySelector('.edit-btn').style.display = 'none';
        li.querySelector('.save-btn').style.display = 'inline';
    }

    if (e.target.classList.contains('save-btn')) {
        const newName = input.value;
        fetch(`/categories/edit/${id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({name: newName})
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                nameSpan.textContent = newName;
                nameSpan.style.display = 'inline';
                input.style.display = 'none';
                li.querySelector('.edit-btn').style.display = 'inline';
                li.querySelector('.save-btn').style.display = 'none';
            }
        });
    }

    if (e.target.classList.contains('delete-btn')) {
        if (!confirm("Are you sure you want to delete this category?")) return;
        fetch(`/categories/delete/${id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                li.remove();
            }
        });
    }
});
</script>
